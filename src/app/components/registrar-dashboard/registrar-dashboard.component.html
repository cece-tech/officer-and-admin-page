<div class="dashboard-container">
  <nav class="navbar">
    <div class="navbar-brand">
      <h2>Registrar Portal - Clearance Management</h2>
    </div>
    <div class="navbar-menu">
      <span class="user-name">{{ currentUser?.full_name }} (Registrar)</span>
      <button (click)="logout()" class="btn-logout">Logout</button>
    </div>
  </nav>

  <div class="dashboard-content">
    <div class="sidebar">
      <ul class="menu">
        <li [class.active]="activeTab === 'dashboard'">
          <a (click)="selectTab('dashboard')">
            <span class="menu-icon">üìä</span>
            Dashboard
          </a>
        </li>
        <li [class.active]="activeTab === 'clearances'">
          <a (click)="selectTab('clearances')">
            <span class="menu-icon">üìã</span>
            All Clearances
          </a>
        </li>
        <li [class.active]="activeTab === 'reports'">
          <a (click)="selectTab('reports')">
            <span class="menu-icon">üìà</span>
            Reports & Analytics
          </a>
        </li>
        <li [class.active]="activeTab === 'audit'">
          <a (click)="selectTab('audit')">
            <span class="menu-icon">üìù</span>
            Audit Log
          </a>
        </li>
      </ul>
    </div>

    <div class="main-content">
      <div *ngIf="isLoading" class="loading">
        <p>Loading...</p>
      </div>

      <!-- Dashboard Tab -->
      <div *ngIf="activeTab === 'dashboard' && !isLoading" class="tab-content">
        <h3>Dashboard Overview</h3>

        <div class="stats-grid">
          <div class="stat-card">
            <h4>Total Students</h4>
            <p class="stat-number">{{ stats.totalStudents }}</p>
          </div>
          <div class="stat-card">
            <h4>Total Clearances</h4>
            <p class="stat-number">{{ stats.totalClearances }}</p>
          </div>
          <div class="stat-card">
            <h4>Pending</h4>
            <p class="stat-number pending">{{ stats.pendingClearances }}</p>
          </div>
          <div class="stat-card">
            <h4>Completed</h4>
            <p class="stat-number completed">{{ stats.completedClearances }}</p>
          </div>
          <div class="stat-card">
            <h4>Rejected</h4>
            <p class="stat-number rejected">{{ stats.rejectedClearances }}</p>
          </div>
          <div class="stat-card">
            <h4>Completion Rate</h4>
            <p class="stat-number">{{ stats.completionRate }}%</p>
          </div>
        </div>

        <div class="recent-section">
          <h4>Recent Clearances</h4>
          <table *ngIf="recentClearances && recentClearances.length > 0">
            <thead>
              <tr>
                <th>Student</th>
                <th>ID</th>
                <th>Section</th>
                <th>Status</th>
                <th>Submitted</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let clearance of recentClearances">
                <td>{{ clearance.student_name }}</td>
                <td>{{ clearance.student_id }}</td>
                <td>{{ clearance.section }}</td>
                <td>
                  <span [class]="'status-badge status-' + clearance.status.toLowerCase()"
                    [style.color]="getStatusColor(clearance.status)">
                    {{ clearance.status }}
                  </span>
                </td>
                <td>{{ clearance.created_at | date:'short' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="department-stats">
          <h4>Department Performance</h4>
          <div *ngFor="let dept of departmentStats" class="dept-stat">
            <div class="dept-header">
              <h5>{{ dept.name }}</h5>
              <span class="dept-count">{{ dept.pending }} pending</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width]="(dept.completed / (dept.completed + dept.pending)) * 100 + '%'"></div>
            </div>
            <p class="dept-details">{{ dept.completed }} completed / {{ dept.total }} total</p>
          </div>
        </div>
      </div>

      <!-- All Clearances Tab -->
      <div *ngIf="activeTab === 'clearances' && !isLoading" class="tab-content">
        <h3>Manage Clearances</h3>

        <div class="filters">
          <select [(ngModel)]="filterStatus" (change)="loadAllClearances()" class="form-control">
            <option value="">All Status</option>
            <option value="PENDING">Pending</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="APPROVED">Approved</option>
            <option value="COMPLETED">Completed</option>
            <option value="REJECTED">Rejected</option>
          </select>
        </div>

        <table *ngIf="allClearances && allClearances.length > 0" class="data-table">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>Student ID</th>
              <th>Section</th>
              <th>Status</th>
              <th>Request Type</th>
              <th>Submitted</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let clearance of allClearances">
              <td>{{ clearance.student_name }}</td>
              <td>{{ clearance.student_id }}</td>
              <td>{{ clearance.section }}</td>
              <td>
                <span [class]="'status-badge status-' + clearance.status.toLowerCase()">
                  {{ clearance.status }}
                </span>
              </td>
              <td>{{ clearance.request_type }}</td>
              <td>{{ clearance.created_at | date:'short' }}</td>
              <td>
                <button class="btn-small">View</button>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="!allClearances || allClearances.length === 0" class="empty-state">
          <p>No clearances found</p>
        </div>
      </div>

      <!-- Reports & Analytics Tab -->
      <div *ngIf="activeTab === 'reports' && !isLoading" class="tab-content">
        <h3>Reports & Analytics</h3>

        <div class="reports-grid">
          <div class="report-card">
            <h4>Export Clearance Data</h4>
            <p>Download all clearance records in various formats</p>
            <div class="button-group">
              <button (click)="exportToCSV()" class="btn-primary">
                üì• Export to CSV
              </button>
              <button (click)="exportToPDF()" class="btn-primary">
                üì• Export to PDF
              </button>
            </div>
          </div>

          <div class="report-card">
            <h4>Department Report</h4>
            <p>Detailed clearance metrics by department</p>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Department</th>
                  <th>Pending</th>
                  <th>Approved</th>
                  <th>Completed</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let dept of departmentStats">
                  <td>{{ dept.name }}</td>
                  <td>{{ dept.pending }}</td>
                  <td>{{ dept.approved }}</td>
                  <td>{{ dept.completed }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="report-card">
            <h4>Performance Metrics</h4>
            <p>Key performance indicators</p>
            <div class="metrics-list">
              <div class="metric">
                <span>Average Processing Time:</span>
                <strong>2.5 days</strong>
              </div>
              <div class="metric">
                <span>Approval Rate:</span>
                <strong>92%</strong>
              </div>
              <div class="metric">
                <span>Resubmission Rate:</span>
                <strong>8%</strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Audit Log Tab -->
      <div *ngIf="activeTab === 'audit' && !isLoading" class="tab-content">
        <h3>System Audit Log</h3>
        <p class="subtitle">Track all system activities and user actions</p>

        <table *ngIf="auditLogs && auditLogs.length > 0" class="audit-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Action</th>
              <th>Entity</th>
              <th>Entity ID</th>
              <th>Timestamp</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let log of auditLogs">
              <td>{{ log.user_name }}</td>
              <td><span class="action-badge">{{ log.action }}</span></td>
              <td>{{ log.model_type }}</td>
              <td>{{ log.model_id }}</td>
              <td>{{ log.created_at | date:'short' }}</td>
              <td class="details">{{ log.description }}</td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="!auditLogs || auditLogs.length === 0" class="empty-state">
          <p>No audit logs found</p>
        </div>
      </div>
    </div>
  </div>
</div>
